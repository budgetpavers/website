{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5 pt-5">
  <h1 class="text-center my-4">Your Shopping Cart</h1>

  <form id="cart-form" onsubmit="return false;" enctype="multipart/form-data">
    {% csrf_token %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Product</th>
          <th>Image</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Subtotal</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="cart-body">
        {% if cart_items %}
          {% for item in cart_items %}
            <tr data-cart-key="{{ item.cart_key }}">
              <td>{{ item.product.name }}</td>
              <td>
                {% if item.product.image %}
                  <img src="{% static 'images/products/' %}{{ item.product.image }}" alt="{{ item.product.name }}" style="max-height: 60px;">
                {% else %}
                  <div style="width: 60px; height: 60px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 12px;">No Image</div>
                {% endif %}
              </td>
              <td>${{ item.product.price|floatformat:2 }}</td>
              <td>
                <input
                  type="number"
                  name="quantity_{{ item.cart_key }}"
                  value="{{ item.quantity }}"
                  min="0"
                  class="form-control text-center quantity-input"
                  data-cart-key="{{ item.cart_key }}">
              </td>
              <td class="subtotal" id="subtotal-{{ item.cart_key }}">${{ item.subtotal|floatformat:2 }}</td>
              <td>
                <button type="button" class="btn btn-danger btn-sm remove-btn" data-cart-key="{{ item.cart_key }}">Remove</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center">Your cart is empty.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    {% if cart_items %}
      <!-- Discount Code Section -->
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-tag me-2"></i>Discount Code</h5>
            </div>
            <div class="card-body">
              <div class="input-group">
                <input type="text" id="discount-code-input" class="form-control" placeholder="Enter discount code" maxlength="50">
                <button type="button" id="apply-discount-btn" class="btn btn-primary">Apply</button>
              </div>
              <div id="discount-message" class="mt-2"></div>

              <!-- Applied Discount Display -->
              <div id="applied-discount" style="display: none;" class="mt-3 p-3 bg-success text-white rounded">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong id="discount-code-display"></strong>
                    <br><small id="discount-description-display"></small>
                    <br><span id="discount-amount-display"></span>
                  </div>
                  <button type="button" id="remove-discount-btn" class="btn btn-sm btn-outline-light">Remove</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cart Summary -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Order Summary</h5>
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span id="subtotal-display">${{ total_price|floatformat:2 }}</span>
              </div>

              <div id="discount-line" class="d-flex justify-content-between mb-2 text-success" style="display: none !important;">
                <span>Discount:</span>
                <span id="discount-total-display">-$0.00</span>
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span>Delivery:</span>
                <span id="delivery-cost-display">${{ delivery_cost|floatformat:2 }}</span>
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span>GST (10%):</span>
                <span id="gst-display">${{ gst|floatformat:2 }}</span>
              </div>

              <hr>

              <div class="d-flex justify-content-between fw-bold">
                <span>Total:</span>
                <span id="total-display">${{ grand_total|floatformat:2 }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </form>

  <div class="mt-4 text-center">
    <a href="{% url 'our_range' %}" class="btn btn-success">Continue Shopping</a>
    <a href="{% url 'homepage' %}" class="btn btn-primary">Back to Calculator</a>
    {% if cart_items %}
      <a href="{% url 'checkout' %}" class="btn btn-warning btn-lg ms-2">Proceed to Checkout</a>
    {% endif %}
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', function () {
  const quantityInputs = document.querySelectorAll('.quantity-input');
  console.log("üéØ Found quantity inputs:", quantityInputs.length);

  // Handle quantity changes in REAL-TIME as they type
  quantityInputs.forEach(input => {
    // Update as they type (with debounce)
    input.addEventListener('input', function () {
      clearTimeout(this.updateTimeout);
      // Wait 500ms after they stop typing before updating
      this.updateTimeout = setTimeout(() => {
        updateCart();
      }, 500);
    });

    // Also update immediately when they click away
    input.addEventListener('blur', function () {
      clearTimeout(this.updateTimeout);
      updateCart();
    });

    // Handle Enter key
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        clearTimeout(this.updateTimeout);
        updateCart();
      }
    });
  });

  // Handle remove buttons
  const removeButtons = document.querySelectorAll('.remove-btn');
  removeButtons.forEach(button => {
    button.addEventListener('click', function () {
      const cartKey = this.dataset.cartKey;
      const quantityInput = document.querySelector(`input[name="quantity_${cartKey}"]`);
      if (quantityInput) {
        quantityInput.value = 0;
        updateCart();
      }
    });
  });

  // Discount code functionality
  const discountInput = document.getElementById('discount-code-input');
  const applyBtn = document.getElementById('apply-discount-btn');
  const removeBtn = document.getElementById('remove-discount-btn');
  const messageDiv = document.getElementById('discount-message');
  const appliedDiv = document.getElementById('applied-discount');

  if (applyBtn) {
    applyBtn.addEventListener('click', applyDiscount);
  }

  if (removeBtn) {
    removeBtn.addEventListener('click', removeDiscount);
  }

  if (discountInput) {
    discountInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyDiscount();
      }
    });
  }

  function applyDiscount() {
    const code = discountInput.value.trim().toUpperCase();

    if (!code) {
      showDiscountMessage('Please enter a discount code', 'danger');
      return;
    }

    applyBtn.disabled = true;
    applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Applying...';

    fetch("{% url 'apply_discount' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
        code: code,
        email: '', // Will be handled in checkout
        delivery_cost: 68.18
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showAppliedDiscount(data.discount);
        updateCartTotals(data.totals);
        showDiscountMessage('Discount applied successfully!', 'success');
        discountInput.value = '';
      } else {
        showDiscountMessage(data.error, 'danger');
      }
    })
    .catch(err => {
      console.error('Error applying discount:', err);
      showDiscountMessage('Failed to apply discount. Please try again.', 'danger');
    })
    .finally(() => {
      applyBtn.disabled = false;
      applyBtn.innerHTML = 'Apply';
    });
  }

  function removeDiscount() {
    fetch("{% url 'remove_discount' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        hideAppliedDiscount();
        // Recalculate totals without discount
        const subtotal = parseFloat(document.getElementById('subtotal-display').textContent.replace('$', ''));
        const delivery = 68.18;
        const gst = (subtotal + delivery) * 0.1;
        const total = subtotal + delivery + gst;

        updateCartTotals({
          subtotal: subtotal,
          discount_amount: 0,
          delivery_cost: delivery,
          gst: gst,
          total: total
        });

        showDiscountMessage('Discount removed', 'info');
      }
    })
    .catch(err => {
      console.error('Error removing discount:', err);
    });
  }

  function showAppliedDiscount(discount) {
    document.getElementById('discount-code-display').textContent = discount.code;
    document.getElementById('discount-description-display').textContent = discount.description || '';

    let amountText = '';
    if (discount.type === 'percentage') {
      amountText = `Save $${discount.amount.toFixed(2)}`;
    } else if (discount.type === 'fixed_amount') {
      amountText = `Save $${discount.amount.toFixed(2)}`;
    } else if (discount.type === 'free_shipping') {
      amountText = 'Free Shipping';
    }

    document.getElementById('discount-amount-display').textContent = amountText;
    appliedDiv.style.display = 'block';

    // Show discount line in summary
    document.getElementById('discount-line').style.display = 'flex';
    document.getElementById('discount-total-display').textContent = `-$${discount.amount.toFixed(2)}`;
  }

  function hideAppliedDiscount() {
    appliedDiv.style.display = 'none';
    document.getElementById('discount-line').style.display = 'none';
  }

  function updateCartTotals(totals) {
    document.getElementById('subtotal-display').textContent = `$${totals.subtotal.toFixed(2)}`;
    document.getElementById('delivery-cost-display').textContent = `$${totals.delivery_cost.toFixed(2)}`;
    document.getElementById('gst-display').textContent = `$${totals.gst.toFixed(2)}`;
    document.getElementById('total-display').textContent = `$${totals.total.toFixed(2)}`;

    if (totals.discount_amount > 0) {
      document.getElementById('discount-total-display').textContent = `-$${totals.discount_amount.toFixed(2)}`;
      document.getElementById('discount-line').style.display = 'flex';
    } else {
      document.getElementById('discount-line').style.display = 'none';
    }
  }

  function showDiscountMessage(message, type) {
    messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;

    // Auto-hide success messages after 3 seconds
    if (type === 'success') {
      setTimeout(() => {
        messageDiv.innerHTML = '';
      }, 3000);
    }
  }

  function updateCart() {
    const formData = new FormData();
    const currentQuantityInputs = document.querySelectorAll('.quantity-input');

    currentQuantityInputs.forEach(qtyInput => {
      formData.append(qtyInput.name, qtyInput.value);
    });

    const csrftoken = getCookie('csrftoken');
    console.log("üì¶ Sending update with:", Object.fromEntries(formData));

    fetch("{% url 'update_cart' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      console.log("‚úÖ Got cart update response:", data);
      if (data.success) {
        // Update subtotals
        data.items.forEach(item => {
          const subtotalCell = document.getElementById(`subtotal-${item.product_id}`);
          if (subtotalCell) {
            subtotalCell.innerText = `$${item.subtotal.toFixed(2)}`;
            console.log(`Updated subtotal for cart key ${item.product_id}: $${item.subtotal.toFixed(2)}`);
          } else {
            console.warn(`Could not find subtotal element for cart key ${item.product_id}`);
          }
        });

        // Update cart summary
        const subtotal = data.total_price;
        const delivery = 68.18;
        const gst = (subtotal + delivery) * 0.1;
        const total = subtotal + delivery + gst;

        document.getElementById('subtotal-display').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('gst-display').textContent = `$${gst.toFixed(2)}`;
        document.getElementById('total-display').textContent = `$${total.toFixed(2)}`;

        // Remove rows with 0 quantity (with smooth animation)
        const currentInputs = document.querySelectorAll('.quantity-input');
        currentInputs.forEach(input => {
          if (parseInt(input.value) === 0) {
            const row = input.closest('tr');
            if (row) {
              // Add fade out animation
              row.style.transition = 'opacity 0.3s ease';
              row.style.opacity = '0.5';
              setTimeout(() => {
                row.remove();

                // Check if cart is empty after removal
                const remainingRows = document.querySelectorAll('#cart-body tr[data-cart-key]');
                if (remainingRows.length === 0) {
                  showEmptyCart();
                }
              }, 300);
            }
          }
        });

        // Show success feedback
        console.log("‚úÖ Cart updated successfully");
      } else {
        console.error("‚ùå Cart update failed:", data.error);
        showDiscountMessage('Failed to update cart: ' + (data.error || 'Unknown error'), 'danger');
      }
    })
    .catch(err => {
      console.error("‚ùå Failed to update cart:", err);
      showDiscountMessage('Network error. Please check your connection and try again.', 'danger');
    });
  }

  function showEmptyCart() {
    document.getElementById('cart-body').innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-shopping-cart fa-2x text-muted mb-2"></i><br>Your cart is empty.</td></tr>';

    // Hide summary sections
    const summarySection = document.querySelector('.row.mt-4');
    if (summarySection) {
      summarySection.style.display = 'none';
    }

    // Hide checkout button
    const checkoutButton = document.querySelector('a[href*="checkout"]');
    if (checkoutButton) {
      checkoutButton.style.display = 'none';
    }

    // Remove any applied discount
    if (removeBtn) {
      removeDiscount();
    }

    // Show message
    showDiscountMessage('All items removed from cart', 'info');
  }
});
</script>
{% endblock %}













